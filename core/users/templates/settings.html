{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6">User Settings</h1>

  <!-- Subscription Management -->
  <section class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Manage Subscription</h2>
    <form method="POST" action="{% url 'subscribe' %}" class="space-y-6">
      {% csrf_token %}
      <div>
        <label for="subscription_plan" class="block text-gray-700">Subscription Plan</label>
        <select id="subscription_plan" name="subscription_plan"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
          <option value="monthly" {% if user.profile.subscription_plan == "monthly" %}selected{% endif %}>
            Monthly - $20 / month
          </option>
          <option value="yearly" {% if user.profile.subscription_plan == "yearly" %}selected{% endif %}>
            Yearly - $200 / year
          </option>
        </select>
      </div>
      <div class="flex items-center space-x-4">
        <button type="submit"
                class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-800 transition">
          Update Subscription
        </button>
        <button type="button"
                id="cancel-subscription"
                class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-800 transition">
          Cancel Subscription
        </button>
      </div>
    </form>
  </section>

  <!-- Personal Information -->
  <section class="mb-8">
    <h2 class="text-2xl font-semibold mb-4">Personal Information</h2>
    <form method="POST" action="{% url 'settings' %}" class="space-y-6">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="first_name" class="block text-gray-700">First Name</label>
          <input id="first_name" type="text" name="first_name" value="{{ user.first_name }}" required
                 class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="middle_name" class="block text-gray-700">Middle Name (Optional)</label>
          <input id="middle_name" type="text" name="middle_name" value="{{ user.profile.middle_name }}"
                 class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="last_name" class="block text-gray-700">Last Name</label>
          <input id="last_name" type="text" name="last_name" value="{{ user.last_name }}" required
                 class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <!-- Address Information -->
      <div>
        <h3 class="text-xl font-semibold mb-4">Address Information</h3>
        <div class="space-y-6">
          <div>
            <label for="address1" class="block text-gray-700">Address Line 1</label>
            <input id="address1" type="text" name="address1" value="{{ user.profile.address1 }}" required
                   class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="address2" class="block text-gray-700">Address Line 2 (Optional)</label>
            <input id="address2" type="text" name="address2" value="{{ user.profile.address2 }}"
                   class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label for="city" class="block text-gray-700">City</label>
              <input id="city" type="text" name="city" value="{{ user.profile.city }}" required
                     class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label for="state" class="block text-gray-700">State/Province</label>
              <input id="state" type="text" name="state" value="{{ user.profile.state }}" required
                     class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label for="zip" class="block text-gray-700">Postal Code (ZIP)</label>
              <input id="zip" type="text" name="zip" value="{{ user.profile.zip }}" required
                     class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6">
        <button type="submit"
                class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-800 transition">
          Save Changes
        </button>
      </div>
    </form>
  </section>
</div>

<!-- JavaScript for Cancel Subscription -->
<script>
  document.getElementById("cancel-subscription").addEventListener("click", function () {
    if (confirm("Are you sure you want to cancel your subscription?")) {
      fetch("{% url 'subscribe' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Subscription cancelled successfully.");
          window.location.reload();
        } else {
          alert("Failed to cancel subscription.");
        }
      })
      .catch(error => console.error("Error:", error));
    }
  });
</script>
{% endblock %}
